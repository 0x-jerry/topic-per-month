<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8">
    <link rel="icon" href="/topic-per-month/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VSCode 如何渲染代码</title>
    <script type="module" crossorigin="" src="/topic-per-month/assets/app.d30f2db1.js"></script>
    <link rel="modulepreload" href="/topic-per-month/assets/vendor.446251b2.js">
    <link rel="stylesheet" href="/topic-per-month/assets/app.10784382.css">
  <link rel="modulepreload" crossorigin="" href="/topic-per-month/assets/docs.f4d1b716.js"><link rel="stylesheet" href="/topic-per-month/assets/docs.8b29c859.css"><link rel="modulepreload" crossorigin="" href="/topic-per-month/assets/render-line.fee5018c.js"><meta property="og:title" content="VSCode 如何渲染代码"><meta name="head:count" content="1"></head>
  <body>
    <div id="app" data-server-rendered="true"><!--[--><!--[--><header class="py-3 px-10 transition-shadow flex bg-white fixed-top card"><!--[--><div class="flex-1 flex"><span class="link gray text-4xl" data-v-98fbdd12=""><a href="/topic-per-month//" class="" data-v-98fbdd12=""><!--[--> 每月一「题」 <!--]--></a></span></div><div class="flex-0 flex"><div class="flex items-end"><small class="mx-1 px-3 rounded-full border text-blue-500 border-blue-500">VSCode 如何渲染代码</small><small class="mx-1 px-3 rounded-full border text-blue-500 border-blue-500">2021.09.13 16:03</small><small class="mx-1 px-3 rounded-full border text-blue-500 border-blue-500">0 字 </small><!--[--><small class="mx-1 px-3 rounded-full border text-gray-500 border-gray-500"> # vscode</small><small class="mx-1 px-3 rounded-full border text-gray-500 border-gray-500"> # js</small><small class="mx-1 px-3 rounded-full border text-gray-500 border-gray-500"> # virtual-list</small><small class="mx-1 px-3 rounded-full border text-gray-500 border-gray-500"> # performance</small><!--]--></div></div><!--]--></header><div class="pl-10 pr-70 pb-10 mt-20"><div><div class="markdown-body"><p></p><div class="table-of-contents"><ul><li><a href="#vscode-%E7%9A%84%E6%95%88%E6%9E%9C"> VSCode 的效果</a></li><li><a href="#%E7%8C%9C%E6%83%B3%E4%BB%A5%E5%8F%8A%E5%B0%9D%E8%AF%95"> 猜想以及尝试</a></li><li><a href="#%E8%A7%A3%E5%AF%86-vscode-%E7%9A%84%E5%81%9A%E6%B3%95"> 解密 VSCode 的做法</a></li><li><a href="#%E7%BB%93%E8%AF%AD"> 结语</a></li></ul></div><p></p><p>本文主要探索， VSCode 是如何把 1w+ 行代码呈现出来，且做到滚动不卡顿的。</p><p>前不久，一同事与我探讨怎么解决渲染大列表的问题。第一个就想到虚拟列表，但是效果不是特别理想。随后想到 VSCode 在滚动大文件（约 1w 多行代码）的时候，很丝滑。随后便研究了一下。特此记录。</p><h2 id="vscode-%E7%9A%84%E6%95%88%E6%9E%9C" tabindex="-1"><span class="link header-anchor" aria-hidden="true" data-v-98fbdd12=""><a href="#vscode-%E7%9A%84%E6%95%88%E6%9E%9C" data-v-98fbdd12=""><!--[-->#<!--]--></a></span> VSCode 的效果</h2><p>用 VSCode 随便打开一个 1w+ 的文件，最初加载的时间，会稍微多一点点。但是之后的滚动，却能做到没有丝毫的白屏。无论是滚动还是拖动，效果都非常的丝滑，简直就像是吃过德芙一样。</p><h2 id="%E7%8C%9C%E6%83%B3%E4%BB%A5%E5%8F%8A%E5%B0%9D%E8%AF%95" tabindex="-1"><span class="link header-anchor" aria-hidden="true" data-v-98fbdd12=""><a href="#%E7%8C%9C%E6%83%B3%E4%BB%A5%E5%8F%8A%E5%B0%9D%E8%AF%95" data-v-98fbdd12=""><!--[-->#<!--]--></a></span> 猜想以及尝试</h2><p>看到这个效果，的第一想法：VSCode 肯定用了虚拟列表，不然 1w+ 的 dom 节点，仅是渲染，都会让页面卡的不行。</p><p>为了验证这个想法，直接找了一个几个 <code>star</code> 较高的虚拟列表库，尝试用了用。例如 <span class="link" target="_blank" rel="noopener noreferrer" data-v-98fbdd12=""><a href="https://bvaughn.github.io/react-virtualized/#/components/List" target="_blank" data-v-98fbdd12=""><span data-v-98fbdd12=""><!--[-->react-virtualized<!--]--></span><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.2em" height="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24" data-v-98fbdd12=""><g fill="none"><path d="M21 3h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="il-md-length-15 il-md-duration-2 il-md-delay-5"></path><path d="M21 3v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="il-md-length-15 il-md-duration-2 il-md-delay-5"></path><path d="M13 11l7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" class="il-md-length-15 il-md-duration-2 il-md-delay-3"></path><path d="M12 5a7 7 0 1 0 7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" class="il-md-length-40 il-md-duration-3 il-md-delay-0"></path></g></svg></a></span> 、<span class="link" target="_blank" rel="noopener noreferrer" data-v-98fbdd12=""><a href="https://tangbc.github.io/vue-virtual-scroll-list/#/keep-state" target="_blank" data-v-98fbdd12=""><span data-v-98fbdd12=""><!--[-->vue-virtual-scroll-list<!--]--></span><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.2em" height="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24" data-v-98fbdd12=""><g fill="none"><path d="M21 3h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="il-md-length-15 il-md-duration-2 il-md-delay-5"></path><path d="M21 3v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="il-md-length-15 il-md-duration-2 il-md-delay-5"></path><path d="M13 11l7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" class="il-md-length-15 il-md-duration-2 il-md-delay-3"></path><path d="M12 5a7 7 0 1 0 7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" class="il-md-length-40 il-md-duration-3 il-md-delay-0"></path></g></svg></a></span>、<span class="link" target="_blank" rel="noopener noreferrer" data-v-98fbdd12=""><a href="https://rintoj.github.io/ngx-virtual-scroller/demo" target="_blank" data-v-98fbdd12=""><span data-v-98fbdd12=""><!--[-->ngx-virtual-scroller<!--]--></span><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.2em" height="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24" data-v-98fbdd12=""><g fill="none"><path d="M21 3h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="il-md-length-15 il-md-duration-2 il-md-delay-5"></path><path d="M21 3v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="il-md-length-15 il-md-duration-2 il-md-delay-5"></path><path d="M13 11l7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" class="il-md-length-15 il-md-duration-2 il-md-delay-3"></path><path d="M12 5a7 7 0 1 0 7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" class="il-md-length-40 il-md-duration-3 il-md-delay-0"></path></g></svg></a></span>。</p><p>这三个都很优秀，但是在快速滚动的时候，都还是会出现一点点白屏的间隙。</p><p>效果都不是特别理想。看来 VSCode 的做法估计还有点不一样。只有啃啃 VSCode 的源代码才接揭晓答案了。</p><h2 id="%E8%A7%A3%E5%AF%86-vscode-%E7%9A%84%E5%81%9A%E6%B3%95" tabindex="-1"><span class="link header-anchor" aria-hidden="true" data-v-98fbdd12=""><a href="#%E8%A7%A3%E5%AF%86-vscode-%E7%9A%84%E5%81%9A%E6%B3%95" data-v-98fbdd12=""><!--[-->#<!--]--></a></span> 解密 VSCode 的做法</h2><p>打开 VSCode 的调试工具，看看具体的渲染效果，如下图：</p><p><img src="/topic-per-month/assets/vscode-render-lines.9e74c493.png" alt="vscode render lines"></p><p>可以看出，的确是利用虚拟列表的技术，仅渲染了可视区域的代码。且是利用 <code>css</code> 的 <code>top</code> 值来确定每一行代码的相对坐标。</p><p><strong>那么它是怎么做到，快速滚动不白屏的呢？</strong></p><p>带着这个疑问，先试试自己去实现一个虚拟列表，差不多也是依葫芦画瓢，效果不是特别理想。快速滚动的时候也会出现白屏。</p><p>粗略分析一下，猜测原因是出在监听 <code>scroll</code> 事件上。因为 <code>scroll</code> 事件是在滚动时触发的。</p><blockquote><p>The <strong>scroll</strong> event fires when the document view has been scrolled. — <span class="link" target="_blank" rel="noopener noreferrer" data-v-98fbdd12=""><a href="https://developer.mozilla.org/en-US/docs/Web/API/Document/scroll_event" target="_blank" data-v-98fbdd12=""><span data-v-98fbdd12=""><!--[-->MDN<!--]--></span><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.2em" height="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24" data-v-98fbdd12=""><g fill="none"><path d="M21 3h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="il-md-length-15 il-md-duration-2 il-md-delay-5"></path><path d="M21 3v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="il-md-length-15 il-md-duration-2 il-md-delay-5"></path><path d="M13 11l7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" class="il-md-length-15 il-md-duration-2 il-md-delay-3"></path><path d="M12 5a7 7 0 1 0 7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" class="il-md-length-40 il-md-duration-3 il-md-delay-0"></path></g></svg></a></span></p></blockquote><p>因此，为了验证这个猜想，把 <code>scroll</code> 事件，换成 <code>wheel</code> 事件。注：这样的做法并不严谨，但是为了验证猜想足以。</p><p>换成 <code>wheel</code> 之后，结果稍稍好了一点点，但是快速滚动依旧是有白屏。看来还是不对。</p><p>这下就越来越对 VSCode 的做法感兴趣了，那么，是时候展现 VSCode 的技术了。</p><p>经过不断的啃代码，总算找到渲染每一行代码的源代码了。 <span class="link" target="_blank" rel="noopener noreferrer" data-v-98fbdd12=""><a href="https://github.com/microsoft/vscode/blob/aa93eefe550167de3ca29aaa3d06f721a47594a3/src/vs/editor/browser/viewParts/lines/viewLines.ts#L559-L621" target="_blank" data-v-98fbdd12=""><span data-v-98fbdd12=""><!--[-->source: viewLines.ts<!--]--></span><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.2em" height="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24" data-v-98fbdd12=""><g fill="none"><path d="M21 3h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="il-md-length-15 il-md-duration-2 il-md-delay-5"></path><path d="M21 3v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="il-md-length-15 il-md-duration-2 il-md-delay-5"></path><path d="M13 11l7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" class="il-md-length-15 il-md-duration-2 il-md-delay-3"></path><path d="M12 5a7 7 0 1 0 7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" class="il-md-length-40 il-md-duration-3 il-md-delay-0"></path></g></svg></a></span></p><div class="language-ts line-numbers-mode"><div class="highlight-lines"><br><div class="highlighted">&nbsp;</div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted">&nbsp;</div><div class="highlighted">&nbsp;</div><br><br></div><pre><code v-pre="">	<span class="token keyword">public</span> <span class="token function">renderText</span><span class="token punctuation">(</span>viewportData<span class="token operator">:</span> ViewportData<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
		<span class="token comment">// (1) render lines - ensures lines are in the DOM</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_visibleLines<span class="token punctuation">.</span><span class="token function">renderLines</span><span class="token punctuation">(</span>viewportData<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_lastRenderedData<span class="token punctuation">.</span><span class="token function">setCurrentVisibleRange</span><span class="token punctuation">(</span>viewportData<span class="token punctuation">.</span>visibleRange<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>domNode<span class="token punctuation">.</span><span class="token function">setWidth</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_context<span class="token punctuation">.</span>viewLayout<span class="token punctuation">.</span><span class="token function">getScrollWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>domNode<span class="token punctuation">.</span><span class="token function">setHeight</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_context<span class="token punctuation">.</span>viewLayout<span class="token punctuation">.</span><span class="token function">getScrollHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// (2) compute horizontal scroll position:</span>
		<span class="token comment">//  - this must happen after the lines are in the DOM since it might need a line that rendered just now</span>
		<span class="token comment">//  - it might change `scrollWidth` and `scrollLeft`</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_horizontalRevealRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>

			<span class="token keyword">const</span> horizontalRevealRequest <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_horizontalRevealRequest<span class="token punctuation">;</span>

			<span class="token comment">// Check that we have the line that contains the horizontal range in the viewport</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>viewportData<span class="token punctuation">.</span>startLineNumber <span class="token operator">&lt;=</span> horizontalRevealRequest<span class="token punctuation">.</span>minLineNumber <span class="token operator">&amp;&amp;</span> horizontalRevealRequest<span class="token punctuation">.</span>maxLineNumber <span class="token operator">&lt;=</span> viewportData<span class="token punctuation">.</span>endLineNumber<span class="token punctuation">)</span> <span class="token punctuation">{</span>

				<span class="token keyword">this</span><span class="token punctuation">.</span>_horizontalRevealRequest <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

				<span class="token comment">// allow `visibleRangesForRange2` to work</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onDidRender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// compute new scroll position</span>
				<span class="token keyword">const</span> newScrollLeft <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_computeScrollLeftToReveal</span><span class="token punctuation">(</span>horizontalRevealRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">if</span> <span class="token punctuation">(</span>newScrollLeft<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_isViewportWrapping<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token comment">// ensure `scrollWidth` is large enough</span>
						<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_ensureMaxLineWidth</span><span class="token punctuation">(</span>newScrollLeft<span class="token punctuation">.</span>maxHorizontalOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token comment">// set `scrollLeft`</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span>_context<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">setScrollPosition</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
						scrollLeft<span class="token operator">:</span> newScrollLeft<span class="token punctuation">.</span>scrollLeft
					<span class="token punctuation">}</span><span class="token punctuation">,</span> horizontalRevealRequest<span class="token punctuation">.</span>scrollType<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// Update max line width (not so important, it is just so the horizontal scrollbar doesn't get too small)</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_updateLineWidthsFast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// Computing the width of some lines would be slow =&gt; delay it</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>_asyncUpdateLineWidths<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>platform<span class="token punctuation">.</span>isLinux <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_asyncCheckMonospaceFontAssumptions<span class="token punctuation">.</span><span class="token function">isScheduled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> rendStartLineNumber <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_visibleLines<span class="token punctuation">.</span><span class="token function">getStartLineNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">const</span> rendEndLineNumber <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_visibleLines<span class="token punctuation">.</span><span class="token function">getEndLineNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> lineNumber <span class="token operator">=</span> rendStartLineNumber<span class="token punctuation">;</span> lineNumber <span class="token operator">&lt;=</span> rendEndLineNumber<span class="token punctuation">;</span> lineNumber<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">const</span> visibleLine <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_visibleLines<span class="token punctuation">.</span><span class="token function">getVisibleLine</span><span class="token punctuation">(</span>lineNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>visibleLine<span class="token punctuation">.</span><span class="token function">needsMonospaceFontCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span>_asyncCheckMonospaceFontAssumptions<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// (3) handle scrolling</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_linesContent<span class="token punctuation">.</span><span class="token function">setLayerHinting</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_canUseLayerHinting<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_linesContent<span class="token punctuation">.</span><span class="token function">setContain</span><span class="token punctuation">(</span><span class="token string">'strict'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> adjustedScrollTop <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_context<span class="token punctuation">.</span>viewLayout<span class="token punctuation">.</span><span class="token function">getCurrentScrollTop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> viewportData<span class="token punctuation">.</span>bigNumbersDelta<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_linesContent<span class="token punctuation">.</span><span class="token function">setTop</span><span class="token punctuation">(</span><span class="token operator">-</span>adjustedScrollTop<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_linesContent<span class="token punctuation">.</span><span class="token function">setLeft</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token keyword">this</span><span class="token punctuation">.</span>_context<span class="token punctuation">.</span>viewLayout<span class="token punctuation">.</span><span class="token function">getCurrentScrollLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><p>从源代码可看出，其做法是确保在 <code>dom</code> 渲染完成之后，再更新滚动条。那么按照这个想法，就需要捕获所有可能的滚动操作，然后在更新滚动值之前，确保 <code>dom</code> 渲染完成。</p><p>从理论上来讲，这样的确能有效的防止白屏。</p><p>光讲理论怎么行呢，还是要试一下才行。尝试用这个方式，写了一个 <span class="link" target="_blank" rel="noopener noreferrer" data-v-98fbdd12=""><a href="https://0x-jerry.github.io/test-vscode-render-lines/" target="_blank" data-v-98fbdd12=""><span data-v-98fbdd12=""><!--[-->demo: test-vscode-render-lines<!--]--></span><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.2em" height="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24" data-v-98fbdd12=""><g fill="none"><path d="M21 3h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="il-md-length-15 il-md-duration-2 il-md-delay-5"></path><path d="M21 3v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="il-md-length-15 il-md-duration-2 il-md-delay-5"></path><path d="M13 11l7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" class="il-md-length-15 il-md-duration-2 il-md-delay-3"></path><path d="M12 5a7 7 0 1 0 7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" class="il-md-length-40 il-md-duration-3 il-md-delay-0"></path></g></svg></a></span>，仅实现捕获 <code>wheel</code> 事件，效果还不错，无论滚动多快，都没有出现白屏。</p><h2 id="%E7%BB%93%E8%AF%AD" tabindex="-1"><span class="link header-anchor" aria-hidden="true" data-v-98fbdd12=""><a href="#%E7%BB%93%E8%AF%AD" data-v-98fbdd12=""><!--[-->#<!--]--></a></span> 结语</h2><p>至此，这次探究告一段论。目前仅尝试在固定每一行高度时，去计算出现在可视区域的 <code>dom</code> 元素，这样能在几乎 1 ms 之内完成。那么，问题来了。如果高度不是固定的，是可变的怎么办呢？计算时间会不会增加，如果列表元素太复杂了，渲染时间增加了，会不会出现滚动卡顿的情况？这些都还是需要测试。</p><p>目前看来，这种做法，在列表元素较少且高度固定时，表现比普通的虚拟列表好。除此之外的情况，或许还是普通的虚拟列表更优吧，这个就等之后再去探索了。</p></div></div><hr class="mt-15"><div class="my-10 text-center"> 除非特殊说明，否则，本站文章均使用 <span class="link" data-v-98fbdd12=""><a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" data-v-98fbdd12=""><span data-v-98fbdd12=""><!--[--> CC BY-NC 4.0 <!--]--></span><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.2em" height="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24" data-v-98fbdd12=""><g fill="none"><path d="M21 3h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="il-md-length-15 il-md-duration-2 il-md-delay-5"></path><path d="M21 3v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="il-md-length-15 il-md-duration-2 il-md-delay-5"></path><path d="M13 11l7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" class="il-md-length-15 il-md-duration-2 il-md-delay-3"></path><path d="M12 5a7 7 0 1 0 7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" class="il-md-length-40 il-md-duration-3 il-md-delay-0"></path></g></svg></a></span> 许可。 </div><hr><div class="comments py-10"></div></div><!--]--><div class="fixed right-0 bottom-0 transition-transform z-50" style="transform:translate(-2rem, 2rem);"><span class="flex bg-light-600 rounded text-3xl hover:bg-light-400 text-gray-600 cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.2em" height="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><path d="M13 19V7.83l4.88 4.88c.39.39 1.03.39 1.42 0a.996.996 0 0 0 0-1.41l-6.59-6.59a.996.996 0 0 0-1.41 0l-6.6 6.58a.996.996 0 1 0 1.41 1.41L11 7.83V19c0 .55.45 1 1 1s1-.45 1-1z" fill="currentColor"></path></svg></span></div><!--]--></div>
    
  

</body></html>